# LonelyCat Memory Spec (v0.1)

> Goal: Define a stable, auditable lifecycle for "memory" in LonelyCat:
> **Proposal → (Accept/Reject/Expire) → Fact → (Revoke/Archive/Reactivate)**
>
> This spec is intentionally minimal and implementation-friendly.
> It defines: entities, lifecycle states, conflict rules, scopes, and audit requirements.

---

## 1. Core Concepts

### 1.1 Proposal
A **Proposal** is a candidate memory item generated by the system (LLM/agent/rules) that is **NOT** active memory yet.
A Proposal becomes a Fact only after an explicit **Accept** action.

Typical UI: "Memory Proposal" card with preview + Accept/Reject.

### 1.2 Fact
A **Fact** is an accepted memory item that the system can use as trusted context.
Facts must be **queryable**, **scoped**, and **reversible** (revoke/archive).

### 1.3 Audit Event
An **Audit Event** is an immutable record describing *who/what* changed *which* memory object and *how*.
Every state transition and mutating operation MUST emit an audit event.

---

## 2. Data Model

### 2.1 Proposal Schema (logical)
- `id`: string (uuid)
- `payload`: object
  - `key`: string
  - `value`: any (JSON)
  - `tags`: string[] (optional)
  - `ttl_seconds`: int (optional; if set, proposal can expire)
- `status`: `pending | accepted | rejected | expired`
- `reason`: string (why this proposal was generated; short natural language)
- `confidence`: float (0..1, optional)
- `scope_hint`: `global | project | session` (optional; UI can preselect)
- `source_ref`: object (required)
  - `kind`: `chat | run | connector | manual`
  - `ref_id`: string (e.g., conversation id, run id, connector run id)
  - `excerpt`: string (optional; short evidence snippet)
- `created_at`: ISO datetime
- `updated_at`: ISO datetime

**Notes**
- `payload.key` should be stable and human readable (e.g., "preferred_name", "timezone", "project_lonelycat_goal").
- `payload.value` MUST be JSON serializable.

### 2.2 Fact Schema (logical)
- `id`: string (uuid)
- `key`: string
- `value`: any (JSON)
- `status`: `active | revoked | archived`
- `scope`: `global | project | session`
- `project_id`: string (nullable; required when scope=project)
- `session_id`: string (nullable; required when scope=session)
- `source_ref`: same as Proposal.source_ref (required)
- `confidence`: float (0..1, optional)
- `version`: int (monotonic, starts at 1)
- `created_at`: ISO datetime
- `updated_at`: ISO datetime

**Notes**
- Facts are never hard-deleted in v0.1.
- Facts support versioning for overwrite operations.

### 2.3 Audit Event Schema (logical)
- `id`: string (uuid)
- `type`: string (enum-like; see section 4)
- `actor`: object
  - `kind`: `user | system`
  - `id`: string (e.g., user id or "system")
- `target`: object
  - `type`: `proposal | fact`
  - `id`: string
- `request_id`: string (optional but recommended)
- `diff`: object (optional)
  - `before`: object (optional)
  - `after`: object (optional)
- `created_at`: ISO datetime

---

## 3. Lifecycle & State Machine

### 3.1 Proposal State Machine
- `pending` (default)
  - can transition to:
    - `accepted` (Accept action)
    - `rejected` (Reject action)
    - `expired` (TTL expires / manual expire)

**Rules**
- A Proposal can be accepted only once.
- Accepting a Proposal MUST create or modify a Fact according to conflict rules.

### 3.2 Fact State Machine
- `active` (default upon accept)
  - can transition to:
    - `revoked` (user/system decides it is wrong; should no longer be used)
    - `archived` (no longer relevant, but kept)
- `revoked` or `archived`
  - can transition to:
    - `active` (reactivate; optional in v0.1, recommended)

**Rules**
- Only `active` facts are used by agents.
- `revoked` facts MUST NOT be surfaced as valid memory by default.

---

## 4. Operations & Required Audit Events

### 4.1 Operations
1) Create Proposal  
2) Reject Proposal  
3) Accept Proposal → create/update Fact  
4) Expire Proposal  
5) Revoke Fact  
6) Archive Fact  
7) Reactivate Fact (optional)  
8) Update Fact value (only via Accept/Overwrite in v0.1)

### 4.2 Audit Event Types (v0.1)
- `proposal.created`
- `proposal.rejected`
- `proposal.accepted`
- `proposal.expired`
- `fact.created`
- `fact.updated` (overwrite)
- `fact.revoked`
- `fact.archived`
- `fact.reactivated` (optional)

**Minimum Requirements**
- Every operation above MUST emit exactly one audit event.
- For `fact.updated`, audit must include a diff `before/after`.

---

## 5. Scopes & Visibility

### 5.1 Scope Definitions
- `global`: available everywhere for the user (default; use carefully)
- `project`: available only within a given project context
- `session`: available only within the current session / thread

### 5.2 Scope Rules
- If scope=`project`, `project_id` MUST be set.
- If scope=`session`, `session_id` MUST be set.
- Query APIs must allow filtering by scope.

---

## 6. Conflict Resolution Rules (Key Collisions)

A **key collision** occurs when accepting a proposal whose `payload.key`
matches one or more existing Facts in the same scope.

### 6.1 Supported Strategies (v0.1)
- `overwrite_latest` (default for keys that are single-valued)
  - update the latest active Fact with same key
  - increment `version`
  - emit `fact.updated`
- `keep_both` (default for keys that are multi-valued)
  - create a new Fact with same key
  - emit `fact.created`

### 6.2 Strategy Selection
- The UI MUST show conflict warning when collision detected.
- The Accept API MUST accept an optional `strategy` field:
  - `overwrite_latest | keep_both`
- If strategy not provided, server uses default based on key policy.

### 6.3 Key Policy (optional but recommended)
Maintain a policy table:
- single-valued keys: `preferred_name`, `timezone`, `language`, ...
- multi-valued keys: `favorite_tools[]`, `projects[]`, `constraints[]`, ...

---

## 7. Source Reference (Evidence)

Every Proposal and Fact MUST have `source_ref`.

### 7.1 source_ref.kind
- `chat`: created from conversation text
- `run`: created by a background run/job
- `connector`: created from external system connector
- `manual`: user directly entered the memory

### 7.2 source_ref.ref_id
A stable identifier used to locate the original source (e.g. conversation id, run id).

### 7.3 source_ref.excerpt
Optional short excerpt as evidence. Keep it small (<= 200 chars).

---

## 8. Security & Roles (informative)

This spec assumes roles exist:
- `viewer`: read-only
- `editor`: can accept/reject, revoke/archive
- `admin`: manage connectors/settings

Minimum: Accept/Reject/Revoke/Archive require editor+.

---

## 9. Non-Goals (v0.1)
- Full text search / embeddings over facts
- Automatic fact merging / dedup
- Multi-user collaboration / shared workspace
- Cross-device sync beyond DB persistence (implementation detail)

---

## 10. Acceptance Criteria for T0.1
- This document exists in repo under `docs/spec/memory.md`
- Team agrees on:
  - Proposal/Fact/Audit definitions
  - Status machines
  - Conflict strategies
  - Required fields (`key/value/scope/status/source_ref`)
- API + UI tasks can be derived without ambiguity
